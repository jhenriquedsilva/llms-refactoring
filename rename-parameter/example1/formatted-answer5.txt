package com.puppycrawl.tools.checkstyle;

import java.util.Locale;

import com.puppycrawl.tools.checkstyle.api.AuditEvent;
import com.puppycrawl.tools.checkstyle.api.SeverityLevel;

public class AuditEventDefaultFormatter implements AuditEventFormatter {

    private static final int LENGTH_OF_ALL_SEPARATORS = 10;

    private static final String SUFFIX = "Check";

    @Override
    public String format(AuditEvent event) {
        final String fileName = event.getFileName();
        final String message = event.getMessage();
        final SeverityLevel severityLevel = event.getSeverityLevel();
        final String severityLevelName;
        if (severityLevel == SeverityLevel.WARNING) {
            severityLevelName = "WARN";
        } else {
            severityLevelName = severityLevel.getName().toUpperCase(Locale.US);
        }
        final StringBuilder sb = initStringBuilderWithOptimalBuffer(event, severityLevelName);
        sb.append('[').append(severityLevelName).append("] ").append(fileName).append(':').append(event.getLine());
        if (event.getColumn() > 0) {
            sb.append(':').append(event.getColumn());
        }
        sb.append(": ").append(message).append(" [");
        if (event.getModuleId() == null) {
            final String checkShortName = getCheckShortName(event);
            sb.append(checkShortName);
        } else {
            sb.append(event.getModuleId());
        }
        sb.append(']');
        return sb.toString();
    }

    private static StringBuilder initStringBuilderWithOptimalBuffer(AuditEvent event, String severityLevelName) {
        final int bufLen = LENGTH_OF_ALL_SEPARATORS + event.getFileName().length() + event.getMessage().length() + severityLevelName.length() + getCheckShortName(event).length();
        return new StringBuilder(bufLen);
    }

    private static String getCheckShortName(AuditEvent event) {
        final String checkFullName = event.getSourceName();
        String checkShortName = checkFullName.substring(checkFullName.lastIndexOf('.') + 1);
        if (checkShortName.endsWith(SUFFIX)) {
            final int endIndex = checkShortName.length() - SUFFIX.length();
            checkShortName = checkShortName.substring(0, endIndex);
        }
        return checkShortName;
    }
}